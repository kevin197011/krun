#!/usr/bin/env sh
# Copyright (c) 2022 Operator
#
# This software is released under the MIT License.
# https://opensource.org/licenses/MIT

# status
if [[ "status" = $1 ]]; then
    echo "[INFO] krun ready!"
    exit 0
fi

# update
if [[ "update" = $1 ]]; then
    echo "[INFO] krun update!"
    curl -sf -o /usr/bin/krun https://raw.githubusercontent.com/kevin197011/sh/main/krun && chmod +x /usr/bin/krun
    exit 0
fi

# custom config first
custom_config='/etc/krun/config.sh'
[[ -d /etc/krun ]] || mkdir -p /etc/krun
[[ -f /etc/krun/config.sh ]] || each 'github_repo_name=""' /etc/krun/config.sh

# import config
source /etc/krun/config.sh
[[ ! -z "${github_repo_name}" ]] && github_repo="https://github.com/${github_repo_name}/sh-libs/tree/main/lib" || github_repo="https://github.com/kevin197011/sh/tree/main/lib"

# list script
if [[ "list" = $1 ]]; then
    echo "[INFO] script list:"
    curl -s ${github_repo} | grep -Eo '[a-zA-Z0-9-]+\.(sh|pl|py|rb)' | uniq | sed 's/^/- /g'
    exit 0
fi

# tmp download run
cd /tmp
curl -s -o $1 https://raw.githubusercontent.com/kevin197011/sh/main/lib/$1

if [[ "${1##*.}" = "sh" ]]; then
    sh $1
fi

if [[ "${1##*.}" = "pl" ]]; then
    perl $1
fi

if [[ "${1##*.}" = "py" ]]; then
    python $1
fi

if [[ "${1##*.}" = "rb" ]]; then
    ruby $1
fi

# end detele script file
rm -rf $1