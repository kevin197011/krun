#!/usr/bin/env python3
# Copyright (c) 2023 kk
#
# This software is released under the MIT License.
# https://opensource.org/licenses/MIT

import sys
import os
import subprocess
import tempfile
import json
import re
import argparse
from urllib.request import Request, urlopen
import ssl


class Krun:
    """Shell script runner"""

    # ASCII art banner
    BANNER = r"""______
___  /____________  ________
__  //_/_  ___/  / / /_  __ \\
_  ,<  _  /   / /_/ /_  / / /
/_/|_| /_/    \__,_/ /_/ /_/
       Shell Script Runner

üöÄ Krun Shell Script Collection"""

    def __init__(self):
        """Initialize Krun instance"""
        self.user_agent = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"
        self.base_url = "https://raw.githubusercontent.com/kevin197011/krun/main"
        self.ssl_context = ssl._create_unverified_context()

    def command_exists(self, command):
        """Check if command exists in system"""
        try:
            subprocess.run([command, '--version'],
                          stdout=subprocess.DEVNULL,
                          stderr=subprocess.DEVNULL)
            return True
        except (OSError, subprocess.CalledProcessError):
            return False

    def get_extension(self, filename):
        """Get file extension"""
        return os.path.splitext(filename)[1].lower()

    def get_interpreter(self, filename, content=None):
        """Get interpreter for shell script"""
        ext = self.get_extension(filename)
        
        # Shell scripts use bash
        if ext in ['.sh', '.bash', '.zsh'] or ext == '':
            return 'bash' if self.command_exists('bash') else None
        
        # Try shebang detection for bash/zsh
        if content and content.startswith('#!'):
            shebang = content.split('\n')[0][2:].strip()
            for cmd in ['bash', 'zsh', 'sh']:
                if cmd in shebang and self.command_exists(cmd):
                    return cmd
        
        return None

    def download_script(self, script_name):
        """Download script content from GitHub"""
        url = f"{self.base_url}/lib/{script_name}"
        req = Request(url)
        req.add_header("User-Agent", self.user_agent)
        return urlopen(req, context=self.ssl_context).read().decode("utf-8")

    def get_script_list(self):
        """Get list of available scripts"""
        url = f"{self.base_url}/meta/lib-manifest.json"
        req = Request(url)
        req.add_header("User-Agent", self.user_agent)
        data = json.loads(urlopen(req, context=self.ssl_context).read().decode("utf-8"))
        # ÊîØÊåÅÊñ∞Ê†ºÂºè {"files": [...]} ÂíåÂÖºÂÆπÊóßÊ†ºÂºè [...]
        if isinstance(data, dict) and "files" in data:
            return data["files"]
        return data if isinstance(data, list) else []

    def group_scripts(self, scripts):
        """Return all scripts as shell scripts"""
        # Only filter shell scripts
        shell_scripts = [s for s in scripts if self.get_extension(s) in ['.sh', '.bash', '.zsh'] or self.get_extension(s) == '']
        return shell_scripts

    def execute_script(self, script_name):
        """Execute a script"""
        try:
            content = self.download_script(script_name)
            interpreter = self.get_interpreter(script_name, content)

            if not interpreter:
                print(f"Error: Cannot determine interpreter for {script_name}")
                return

            # Create temporary file
            with tempfile.NamedTemporaryFile(mode='w', suffix=self.get_extension(script_name), delete=False) as tmp_file:
                tmp_file.write(content)
                tmp_path = tmp_file.name

            # Make executable and run
            os.chmod(tmp_path, 0o755)
            print(f"Executing {script_name} with {interpreter}...")
            subprocess.run([interpreter, tmp_path])

        except KeyboardInterrupt:
            print("\nScript execution interrupted by user")
        except Exception as e:
            print(f"Error executing script: {e}")
        finally:
            # Cleanup
            try:
                os.remove(tmp_path)
            except:
                pass

    def debug_script(self, script_name):
        """Show debug information for script"""
        try:
            content = self.download_script(script_name)
            interpreter = self.get_interpreter(script_name, content)

            print("=== Script Debug Information ===")
            print(f"Filename: {script_name}")
            print(f"Extension: {self.get_extension(script_name)}")
            print(f"Interpreter: {interpreter}")
            print("\n=== Script Content ===")
            print(content)

        except Exception as e:
            print(f"Error: {e}")

    def show_list(self):
        """Show list of available scripts"""
        print(self.BANNER)
        print("=" * 50)

        scripts = self.get_script_list()
        shell_scripts = self.group_scripts(scripts)

        print(f"\nüìä Total Scripts: {len(shell_scripts)}")
        print()

        num = 1
        print("üêö Shell Scripts")
        print("‚îÄ" * 40)
        for script in shell_scripts:
            print(f"    [{num:2}] {script}")
            num += 1
        print()

        print("üí° Usage: krun <number> or krun <script_name>")
        print("üîç Debug: krun <number> --debug")

    def show_status(self):
        """Show system status"""
        print("Krun ready!")
        if self.command_exists('bash'):
            print("‚úì bash is available")
        else:
            print("‚úó bash is not available")

    def show_languages(self):
        """Show supported languages"""
        print(self.BANNER)
        print("\nSupported format:")
        print("  ‚úì Shell scripts (.sh, .bash, .zsh)")
        print("\nInterpreter: bash")

    def show_help(self):
        """Show help message"""
        print(self.BANNER)
        print("\nUsage:")
        print("  krun list                    - List all shell scripts")
        print("  krun <number>                - Execute script by number")
        print("  krun <script_name>           - Execute script by name")
        print("  krun <number|script> --debug - Show debug info")
        print("  krun status                  - Show system status")
        print("  krun languages               - Show supported format")
        print("  krun version                 - Show version")
        print("  krun help                    - Show this help")
        print("\nExamples:")
        print("  krun 1                       - Execute first script")
        print("  krun hello-world.sh          - Execute hello-world.sh")
        print("  krun 5 --debug               - Debug script #5")

    def show_version(self):
        """Show version information"""
        print(self.BANNER)
        print("\nv2.0")
        print("Copyright (c) 2023 kk")
        print("MIT License")

    def run_by_number(self, number, debug=False):
        """Run script by number"""
        scripts = self.get_script_list()
        try:
            script_name = scripts[int(number) - 1]
            if debug:
                self.debug_script(script_name)
            else:
                self.execute_script(script_name)
        except IndexError:
            print(f"Error: Script #{number} not found")

    def run_by_name(self, script_name, debug=False):
        """Run script by name"""
        if debug:
            self.debug_script(script_name)
        else:
            self.execute_script(script_name)

    def is_script_name(self, name):
        """Check if name looks like a shell script file"""
        return re.match(r".*\.(sh|bash|zsh)$", name, re.IGNORECASE)

    def run(self, args):
        """Main entry point"""
        parser = argparse.ArgumentParser(
            description="Shell script runner",
            formatter_class=argparse.RawDescriptionHelpFormatter,
            epilog="""
Examples:
  krun list                   List all available shell scripts
  krun 1                      Execute first script
  krun hello-world.sh         Execute hello-world.sh
  krun 5 --debug              Show debug info for script #5
  krun status                 Show system status
  krun languages              Show supported format
  krun version                Show version information
            """
        )

        parser.add_argument('command', nargs='?', help='Command or script to run')
        parser.add_argument('--debug', action='store_true', help='Show debug information')
        parser.add_argument('--version', action='version', version='krun v2.0')

        # Parse arguments
        parsed_args = parser.parse_args(args)

        # Handle commands
        if not parsed_args.command:
            self.show_help()
            return

        command = parsed_args.command

        if command == "list":
            self.show_list()
        elif command == "help":
            self.show_help()
        elif command == "status":
            self.show_status()
        elif command == "version":
            self.show_version()
        elif command == "languages":
            self.show_languages()
        elif command.isdigit():
            # Execute by number
            self.run_by_number(command, parsed_args.debug)
        elif self.is_script_name(command):
            # Execute by script name
            self.run_by_name(command, parsed_args.debug)
        else:
            print(f"Error: Unknown command '{command}'")
            self.show_help()


def main():
    """Main function"""
    krun = Krun()
    krun.run(sys.argv[1:])


if __name__ == "__main__":
    main()
